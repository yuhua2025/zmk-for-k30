name: Build K30 Keyboard - USB Logging Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
      - name: Cache west modules
        uses: actions/cache@v4
        env:
          cache-name: cache-zephyr-modules
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('app/west.yml') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - name: Initialize ZMK
        run: |
          # 检查目录结构并找到正确的west.yml文件位置
          echo "检查目录结构..."
          ls -la
          find . -name "west.yml" -type f

          # 直接在根目录初始化，让west自动查找west.yml
          west init
          west update
          west zephyr-export
      - name: Check and create USB logging snippet
        run: |
          # 确保zmk-usb-logging snippet存在
          # 确定正确的snippet目录位置，优先使用app/snippets
          SNIPPET_DIR="app/snippets"
          mkdir -p "$SNIPPET_DIR"
          echo "使用snippet目录: $SNIPPET_DIR"

          # 在确定的位置创建snippet
          if [ ! -d "$SNIPPET_DIR/zmk-usb-logging" ]; then
            echo "在 $SNIPPET_DIR 创建zmk-usb-logging snippet目录"
            mkdir -p "$SNIPPET_DIR/zmk-usb-logging"
            
            # 创建snippet配置文件
            echo "name: zmk-usb-logging" > "$SNIPPET_DIR/zmk-usb-logging/snippet.yml"
            echo "append: " >> "$SNIPPET_DIR/zmk-usb-logging/snippet.yml"
            echo "  - zmk-usb-logging.conf" >> "$SNIPPET_DIR/zmk-usb-logging/snippet.yml"
            echo "  - zmk-usb-logging.overlay" >> "$SNIPPET_DIR/zmk-usb-logging/snippet.yml"
            
            # 创建配置文件
            echo "CONFIG_ZMK_USB_LOGGING=y" > "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.conf"
            
            # 创建设备树覆盖文件
            echo '/' > "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '{' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '    chosen {' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '        zephyr,console = &snippet_zmk_usb_logging_uart;' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '        zephyr,shell-uart = &snippet_zmk_usb_logging_uart;' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '    };' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '};' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '&zephyr_udc0 {' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '    snippet_zmk_usb_logging_uart: snippet_zmk_usb_logging_uart {' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '        compatible = "zephyr,cdc-acm-uart";' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '        label = "CDC_ACM_0";' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '    };' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
            echo '};' >> "$SNIPPET_DIR/zmk-usb-logging/zmk-usb-logging.overlay"
          else
            echo "zmk-usb-logging snippet已在 $SNIPPET_DIR 存在"
          fi

          # 确定正确的k30目录位置，优先使用app/boards/shields/k30
          K30_DIR="app/boards/shields/k30"
          mkdir -p "$K30_DIR"
          echo "已创建k30目录: $(ls -la "$(dirname "$K30_DIR")" 2>/dev/null)"

          # 确保k30.conf包含必要的USB日志依赖配置
          if [ -f "$K30_DIR/k30.conf" ]; then
            echo "检查k30.conf是否已包含USB日志配置"
            # 检查是否已包含配置
            if ! grep -q "CONFIG_ZMK_USB_LOGGING" "$K30_DIR/k30.conf"; then
              echo "添加USB日志依赖配置到k30.conf"
              echo 'CONFIG_LOG=y' >> "$K30_DIR/k30.conf"
              echo 'CONFIG_USB_DEVICE=y' >> "$K30_DIR/k30.conf"
              echo 'CONFIG_USB_DEVICE_STACK=y' >> "$K30_DIR/k30.conf"
              echo 'CONFIG_SERIAL_SUPPORT_INTERRUPT=y' >> "$K30_DIR/k30.conf"
              echo 'CONFIG_CONSOLE=y' >> "$K30_DIR/k30.conf"
              echo 'CONFIG_USB_CDC_ACM=y' >> "$K30_DIR/k30.conf"
              echo 'CONFIG_UART_CONSOLE=y' >> "$K30_DIR/k30.conf"
              echo 'CONFIG_UART_INTERRUPT_DRIVEN=y' >> "$K30_DIR/k30.conf"
            else
              echo "k30.conf已包含USB日志配置"
            fi
          else
            echo "创建k30.conf并添加USB日志配置"
            echo 'CONFIG_LOG=y' > "$K30_DIR/k30.conf"
            echo 'CONFIG_USB_DEVICE=y' >> "$K30_DIR/k30.conf"
            echo 'CONFIG_USB_DEVICE_STACK=y' >> "$K30_DIR/k30.conf"
            echo 'CONFIG_SERIAL_SUPPORT_INTERRUPT=y' >> "$K30_DIR/k30.conf"
            echo 'CONFIG_CONSOLE=y' >> "$K30_DIR/k30.conf"
            echo 'CONFIG_USB_CDC_ACM=y' >> "$K30_DIR/k30.conf"
            echo 'CONFIG_UART_CONSOLE=y' >> "$K30_DIR/k30.conf"
            echo 'CONFIG_UART_INTERRUPT_DRIVEN=y' >> "$K30_DIR/k30.conf"
          fi

          # 同时创建备用的zmk/app路径（如果需要）
          if [ -d "zmk" ]; then
            echo "创建备用zmk/app路径结构"
            mkdir -p "zmk/app/boards/shields/k30"
            # 复制k30.conf到备用路径
            if [ -f "$K30_DIR/k30.conf" ]; then
              cp "$K30_DIR/k30.conf" "zmk/app/boards/shields/k30/"
            fi
            # 复制snippet到备用路径
            mkdir -p "zmk/app/snippets"
            if [ -d "$SNIPPET_DIR/zmk-usb-logging" ]; then
              cp -r "$SNIPPET_DIR/zmk-usb-logging" "zmk/app/snippets/"
            fi
          fi

      - name: Debug Information
        run: |
          echo "工作目录: $(pwd)"
          echo "列出根目录内容..."
          ls -la

          # 检查主要目录
          echo "检查app目录..."
          ls -la app/ 2>/dev/null || echo "app目录不存在"

          # 检查zmk目录
          echo "检查zmk目录..."
          ls -la zmk/ 2>/dev/null || echo "zmk目录不存在"
          if [ -d "zmk" ]; then
            echo "zmk/app目录内容..."
            ls -la zmk/app/ 2>/dev/null || echo "zmk/app目录不存在"
          fi

          # 检查snippets目录（优先app/snippets）
          echo "列出snippets目录内容..."
          if [ -d "app/snippets" ]; then
            ls -la app/snippets/
            echo "列出zmk-usb-logging目录内容..."
            ls -la app/snippets/zmk-usb-logging/ 2>/dev/null || echo "zmk-usb-logging snippet不存在"
            # 检查snippet配置文件
            if [ -f "app/snippets/zmk-usb-logging/snippet.yml" ]; then
              echo "snippet.yml内容:"
              cat app/snippets/zmk-usb-logging/snippet.yml
            fi
          elif [ -d "zmk/app/snippets" ]; then
            ls -la zmk/app/snippets/
            echo "列出zmk-usb-logging目录内容..."
            ls -la zmk/app/snippets/zmk-usb-logging/ 2>/dev/null || echo "zmk-usb-logging snippet不存在"
            # 检查snippet配置文件
            if [ -f "zmk/app/snippets/zmk-usb-logging/snippet.yml" ]; then
              echo "snippet.yml内容:"
              cat zmk/app/snippets/zmk-usb-logging/snippet.yml
            fi
          else
            echo "snippets目录不存在"
          fi

          # 检查k30配置文件
          echo "列出k30配置文件内容..."
          if [ -f "app/boards/shields/k30/k30.conf" ]; then
            echo "app/boards/shields/k30/k30.conf内容:"
            cat app/boards/shields/k30/k30.conf
          elif [ -f "zmk/app/boards/shields/k30/k30.conf" ]; then
            echo "zmk/app/boards/shields/k30/k30.conf内容:"
            cat zmk/app/boards/shields/k30/k30.conf
          else
            echo "k30.conf不存在"
          fi

          # 检查zephyr目录
          echo "检查zephyr目录..."
          ls -la zephyr/ 2>/dev/null || echo "zephyr目录不存在"

      - name: Build firmware
        run: |
          # 添加详细的目录结构检查
          echo "=== 当前工作目录 ==="
          pwd

          echo "=== 根目录结构 ==="
          ls -la

          # 查找所有app目录
          echo "=== 查找所有app目录 ==="
          find . -name "app" -type d

          # 查找所有CMakeLists.txt文件（限制深度以避免过多输出）
          echo "=== 查找所有CMakeLists.txt文件（限制深度） ==="
          find . -maxdepth 3 -name "CMakeLists.txt"

          # 查找正确的west.yml文件位置
          echo "=== 查找west.yml文件 ==="
          find . -name "west.yml"

          # 检查是否存在zmk目录
          echo "=== 检查zmk目录 ==="
          ls -la zmk/ 2>/dev/null || echo "zmk目录不存在"

          # 检查zmk/app目录内容
          echo "=== 检查zmk/app目录内容 ==="
          ls -la zmk/app/ 2>/dev/null || echo "zmk/app目录不存在或无法访问"

          # 检查app目录是否存在及内容
          echo "=== 检查app目录内容 ==="
          ls -la app/ 2>/dev/null || echo "app目录不存在或无法访问"

          # 检查是否存在zephyr目录及其内容
          echo "=== 检查zephyr目录内容 ==="
          ls -la zephyr/ 2>/dev/null || echo "zephyr目录不存在"

          # 检查根目录是否有CMakeLists.txt
          echo "=== 检查根目录CMakeLists.txt ==="
          if [ -f "CMakeLists.txt" ]; then
            cat CMakeLists.txt | head -n 20
          else
            echo "根目录没有CMakeLists.txt"
          fi

          # 基于项目结构调整构建策略
          # 1. 首先检查是否存在根目录构建方法（适用于子模块方式）
          if [ -f "CMakeLists.txt" ]; then
            echo "发现根目录CMakeLists.txt，尝试直接在根目录构建"
            mkdir -p build
            cd build
            cmake -GNinja -DBOARD=nrfmicro_13 -DZMK_CONFIG="$GITHUB_WORKSPACE/config" -DSHIELD=k30 .. && \
            ninja || {
              echo "根目录构建失败，尝试其他方法"
              cd ..
            }
          fi

          # 2. 检查app目录是否有CMakeLists.txt
          if [ -d "app" ] && [ -f "app/CMakeLists.txt" ]; then
            echo "找到app目录及其CMakeLists.txt，使用此路径作为构建源"
            west build -b nrfmicro_13 -s app -- \
              -DZMK_CONFIG="$GITHUB_WORKSPACE/config" \
              -DSHIELD=k30 && exit 0
          fi

          # 3. 检查是否可以直接使用zephyr目录构建（适用于GitHub Actions环境）
          if [ -d "zephyr" ]; then
            echo "尝试使用zephyr目录作为基础进行构建"
            # 创建临时构建配置
            mkdir -p temp_build
            cd temp_build
            if [ -d "../app" ]; then
              echo "使用app目录作为应用源"
              west build -b nrfmicro_13 -s ../app -- \
                -DZMK_CONFIG="$GITHUB_WORKSPACE/config" \
                -DSHIELD=k30 && exit 0
            else
              echo "尝试直接构建"
              west build -b nrfmicro_13 -- \
                -DZMK_CONFIG="$GITHUB_WORKSPACE/config" \
                -DSHIELD=k30 && exit 0
            fi
          fi

          # 4. 最后尝试创建配置目录并使用zmk构建方式
          echo "尝试最终构建方法：创建配置并使用zmk构建"
          mkdir -p config
          # 确保shield配置存在
          echo "CONFIG_SHIELD=k30" > config/zmk-config.conf
          echo "CONFIG_ZMK_USB_LOGGING=y" >> config/zmk-config.conf

          # 尝试构建
          west build -b nrfmicro_13 -s app -- \
            -DZMK_CONFIG="$GITHUB_WORKSPACE/config" 

          # 如果所有方法都失败，显示详细错误信息
          echo "构建失败！显示构建目录内容和日志以帮助诊断"
          if [ -d "build/zephyr" ]; then
            ls -la build/zephyr/
            if [ -f "build/zephyr/build.log" ]; then
              echo "构建日志内容:" 
              tail -n 200 build/zephyr/build.log
            fi
          fi
          exit 1

      - name: Verify Build Output
        run: |
          echo "检查构建输出..."
          # 查找所有可能的固件文件位置
          FIRMWARE_FILES=$(find . -name "zmk.hex" -o -name "zmk.uf2")

          if [ -z "$FIRMWARE_FILES" ]; then
            echo "错误: 未找到固件文件!"
            # 检查标准构建目录是否存在
            if [ -d "build/zephyr" ]; then
              echo "构建目录内容:"
              ls -la build/zephyr/
              # 显示构建日志以帮助调试
              if [ -f "build/zephyr/build.log" ]; then
                echo "构建日志内容:"
                tail -n 100 build/zephyr/build.log
              fi
            else
              echo "构建目录不存在，检查其他可能的位置..."
              find . -name "build" -type d | xargs ls -la 2>/dev/null || echo "未找到构建目录"
            fi
            exit 1
          else
            echo "找到固件文件:"
            echo "$FIRMWARE_FILES"
            # 显示固件文件的详细信息
            for file in $FIRMWARE_FILES; do
              echo "文件信息: $file"
              ls -lh "$file"
            done
          fi

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: k30-usb-logging-firmware
          path: build/zephyr/zmk.uf2
