name: Build ZMK Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root
    
    strategy:
      matrix:
        include:
          - board: nrfmicro_13
            shield: k30
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Complete ZMK setup
        run: |
          # 完整的 ZMK 初始化流程
          west init -l config
          west update
          west zephyr-export
          
          # 验证环境
          echo "ZEPHYR_BASE: $ZEPHYR_BASE"
          echo "Workspace: $GITHUB_WORKSPACE"
          
          # 手动设置 Zephyr 基础路径（如果环境变量未正确设置）
          if [ -z "$ZEPHYR_BASE" ]; then
            export ZEPHYR_BASE="$GITHUB_WORKSPACE/zephyr"
          fi
          
          # 检查关键文件
          ls -la zmk/app/CMakeLists.txt || echo "ZMK app CMakeLists.txt not found"
          ls -la zephyr/ || echo "Zephyr directory not found"

      - name: Build
        run: |
          cd zmk/app
          west build -b ${{ matrix.board }} -- \
            -DZMK_CONFIG="$GITHUB_WORKSPACE/config" \
            -DSHIELD=${{ matrix.shield }}

      - uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: build/zephyr/zmk.uf2
